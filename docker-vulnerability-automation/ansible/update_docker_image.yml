---
# Ansible Playbook for Automatic Docker Image Update with Healthcheck and Rollback
# Usage: ansible-playbook update_docker_image.yml -e "image_name=nginx image_version=1.23.3"

- hosts: localhost
  gather_facts: no
  vars:
    compose_path: "{{ lookup('env', 'COMPOSE_PATH') | default('../application') }}"
    app_port: "{{ lookup('env', 'APP_PORT') | default('8087') }}"

  tasks:
    # Task 1: Backup docker-compose.yml for rollback
    - name: Backup docker-compose.yml before modification
      copy:
        src: "{{ compose_path }}/docker-compose.yml"
        dest: "{{ compose_path }}/docker-compose.yml.backup"
        remote_src: yes

    # Task 2: Read Docker Compose file
    - name: Read Docker Compose file
      slurp:
        src: "{{ compose_path }}/docker-compose.yml"
      register: file

    # Task 3: Decode file content (base64 -> text)
    - name: Decode base64 file content
      set_fact:
        file_content: "{{ file.content | b64decode }}"

    # Main block with automatic rollback on failure
    - name: Update with automatic rollback
      block:
        # Task 4: Update image version in Docker Compose file
        - name: Update image for service {{ image_name }}
          lineinfile:
            path: "{{ compose_path }}/docker-compose.yml"
            regexp: "^\\s*image:\\s*{{ image_name }}:.*$"
            line: "    image: {{ image_name }}:{{ image_version }}"
          when: file_content is defined and image_name != "" and image_version != ""

        # Task 5: Pull new image version
        - name: Pull new image version
          ansible.builtin.command:
            cmd: docker compose pull
          args:
            chdir: "{{ compose_path }}"
          register: pull_result
          changed_when: "'Pulled' in pull_result.stdout or 'Downloaded' in pull_result.stdout"

        # Task 6: Restart application with new image
        - name: Restart application with docker compose up -d
          ansible.builtin.command:
            cmd: docker compose up -d
          args:
            chdir: "{{ compose_path }}"
          register: restart_result

        # Task 7: Healthcheck - Verify application responds
        - name: Wait for application to be ready
          uri:
            url: "http://localhost:{{ app_port }}"
            method: GET
            status_code: 200
          register: health_check
          retries: 5
          delay: 3
          until: health_check.status == 200

      rescue:
        # Rollback on failure
        - name: "ROLLBACK - Restore docker-compose.yml"
          copy:
            src: "{{ compose_path }}/docker-compose.yml.backup"
            dest: "{{ compose_path }}/docker-compose.yml"
            remote_src: yes

        - name: "ROLLBACK - Restart with previous configuration"
          ansible.builtin.command:
            cmd: docker compose up -d
          args:
            chdir: "{{ compose_path }}"

        - name: "ROLLBACK - Error message"
          fail:
            msg: "Update failed! Rollback completed to previous version."

    # Task 8: Get container status
    - name: Display Docker container status
      ansible.builtin.command:
        cmd: docker ps
      register: docker_ps_output
      changed_when: false

    # Task 9: Display docker ps result
    - name: Display docker ps result
      debug:
        var: docker_ps_output.stdout_lines

    # Task 10: Update summary
    - name: Update summary
      debug:
        msg:
          - "========================================="
          - "Update completed successfully!"
          - "Updated image: {{ image_name }}:{{ image_version }}"
          - "Healthcheck: OK"
          - "Application restarted"
          - "========================================="
