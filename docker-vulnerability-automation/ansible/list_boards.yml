---
# Utility playbook to list all accessible WeKan boards and retrieve IDs
# Usage: ansible-playbook list_boards.yml

- hosts: localhost
  gather_facts: no
  vars:
    wekan_url: "{{ lookup('env', 'WEKAN_URL') | default('http://YOUR_WEKAN_URL:8080') }}"
    wekan_user: "{{ lookup('env', 'WEKAN_USER') | default('your-username') }}"
    wekan_pass: "{{ lookup('env', 'WEKAN_PASS') | default('your-password') }}"

  tasks:
    - name: Authenticate to WeKan
      uri:
        url: "{{ wekan_url }}/users/login"
        method: POST
        body_format: json
        body:
          username: "{{ wekan_user }}"
          password: "{{ wekan_pass }}"
        status_code: 200
      register: wekan_auth

    - name: Extract token and user ID
      set_fact:
        wekan_token: "{{ wekan_auth.json.token }}"
        wekan_user_id: "{{ wekan_auth.json.id }}"

    - name: Display connected user ID
      debug:
        msg: "Connected User ID: {{ wekan_user_id }}"

    - name: Get all user boards
      uri:
        url: "{{ wekan_url }}/api/users/{{ wekan_user_id }}/boards"
        method: GET
        headers:
          Authorization: "Bearer {{ wekan_token }}"
        status_code: 200
      register: user_boards

    - name: Display all boards
      debug:
        msg: "Board: '{{ item.title }}' - ID: {{ item._id }}"
      loop: "{{ user_boards.json }}"
      when: user_boards.json is iterable and user_boards.json is not mapping

    - name: Display full response if issue
      debug:
        var: user_boards.json
      when: user_boards.json is mapping or (user_boards.json is not iterable)
