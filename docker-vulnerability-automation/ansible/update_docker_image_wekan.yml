---
# Ansible Playbook for Automatic Docker Image Update with WeKan Tracking
# Usage: ansible-playbook update_docker_image_wekan.yml -e "image_name=nginx image_version=1.23.3"
# With Vault: ansible-playbook update_docker_image_wekan.yml -e "image_name=nginx image_version=1.23.3" --ask-vault-pass

- hosts: localhost
  gather_facts: yes
  vars:
    # WeKan Configuration (replace with your values)
    wekan_url: "{{ lookup('env', 'WEKAN_URL') | default('http://YOUR_WEKAN_URL:8080') }}"
    wekan_user: "{{ vault_wekan_user | default('your-username') }}"
    wekan_pass: "{{ vault_wekan_pass | default('your-password') }}"
    board_id: "{{ lookup('env', 'WEKAN_BOARD_ID') | default('YOUR_BOARD_ID') }}"
    swimlane_id: "{{ lookup('env', 'WEKAN_SWIMLANE_ID') | default('YOUR_SWIMLANE_ID') }}"
    author_id: "{{ lookup('env', 'WEKAN_AUTHOR_ID') | default('YOUR_AUTHOR_ID') }}"
    list_todo: "{{ lookup('env', 'WEKAN_LIST_TODO') | default('YOUR_TODO_LIST_ID') }}"
    list_inprogress: "{{ lookup('env', 'WEKAN_LIST_INPROGRESS') | default('YOUR_INPROGRESS_LIST_ID') }}"
    list_done: "{{ lookup('env', 'WEKAN_LIST_DONE') | default('YOUR_DONE_LIST_ID') }}"
    compose_path: "{{ lookup('env', 'COMPOSE_PATH') | default('../application') }}"
    app_port: "{{ lookup('env', 'APP_PORT') | default('8087') }}"

  vars_files:
    - vault.yml

  tasks:
    # ========================================
    # PART 1: WeKan Authentication
    # ========================================

    - name: Authenticate to WeKan
      uri:
        url: "{{ wekan_url }}/users/login"
        method: POST
        body_format: json
        body:
          username: "{{ wekan_user }}"
          password: "{{ wekan_pass }}"
        status_code: 200
      register: wekan_auth

    - name: Extract WeKan token
      set_fact:
        wekan_token: "{{ wekan_auth.json.token }}"

    # ========================================
    # PART 2: Create WeKan Ticket
    # ========================================

    - name: Create new WeKan ticket in ToDo
      uri:
        url: "{{ wekan_url }}/api/boards/{{ board_id }}/lists/{{ list_todo }}/cards"
        method: POST
        headers:
          Authorization: "Bearer {{ wekan_token }}"
        body_format: json
        body:
          title: "Update {{ image_name }}:{{ image_version }}"
          description: "Automatic Docker image update via Ansible\n\nImage: {{ image_name }}\nTarget version: {{ image_version }}\nDate: {{ ansible_date_time.iso8601 }}"
          swimlaneId: "{{ swimlane_id }}"
          authorId: "{{ author_id }}"
        status_code: [200, 201]
      register: wekan_card

    - name: Extract created card ID
      set_fact:
        card_id: "{{ wekan_card.json._id }}"

    - name: Display created ticket ID
      debug:
        msg: "WeKan ticket created - ID: {{ card_id }}"

    # ========================================
    # PART 3: Backup (for rollback)
    # ========================================

    - name: Backup docker-compose.yml before modification
      copy:
        src: "{{ compose_path }}/docker-compose.yml"
        dest: "{{ compose_path }}/docker-compose.yml.backup"
        remote_src: yes

    - name: Add comment about backup
      uri:
        url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
        method: POST
        headers:
          Authorization: "Bearer {{ wekan_token }}"
        body_format: json
        body:
          authorId: "{{ author_id }}"
          comment: "docker-compose.yml backup created (rollback available on failure)"
        status_code: [200, 201]

    # ========================================
    # PART 4: Update Docker Image
    # ========================================

    - name: Read Docker Compose file
      slurp:
        src: "{{ compose_path }}/docker-compose.yml"
      register: file

    - name: Decode base64 file content
      set_fact:
        file_content: "{{ file.content | b64decode }}"

    # Main block with rollback on failure
    - name: Update with automatic rollback
      block:
        - name: Update image for service {{ image_name }}
          lineinfile:
            path: "{{ compose_path }}/docker-compose.yml"
            regexp: "^\\s*image:\\s*{{ image_name }}:.*$"
            line: "    image: {{ image_name }}:{{ image_version }}"
          when: file_content is defined and image_name != "" and image_version != ""
          register: file_updated

        # ========================================
        # PART 5: Comment after modification
        # ========================================

        - name: Read updated Docker Compose file
          slurp:
            src: "{{ compose_path }}/docker-compose.yml"
          register: updated_file

        - name: Add comment with modified file content
          uri:
            url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
            method: POST
            headers:
              Authorization: "Bearer {{ wekan_token }}"
            body_format: json
            body:
              authorId: "{{ author_id }}"
              comment: "docker-compose.yml updated\n\n```yaml\n{{ updated_file.content | b64decode }}\n```"
            status_code: [200, 201]

        # ========================================
        # PART 6: Move ticket to InProgress
        # ========================================

        - name: Move ticket to InProgress
          uri:
            url: "{{ wekan_url }}/api/boards/{{ board_id }}/lists/{{ list_todo }}/cards/{{ card_id }}"
            method: PUT
            headers:
              Authorization: "Bearer {{ wekan_token }}"
            body_format: json
            body:
              listId: "{{ list_inprogress }}"
              swimlaneId: "{{ swimlane_id }}"
            status_code: [200, 204]

        # ========================================
        # PART 7: Pull new image
        # ========================================

        - name: Pull new image version
          ansible.builtin.command:
            cmd: docker compose pull
          args:
            chdir: "{{ compose_path }}"
          register: pull_result
          changed_when: "'Pulled' in pull_result.stdout or 'Downloaded' in pull_result.stdout or 'Pulled' in pull_result.stderr or 'Downloaded' in pull_result.stderr"

        - name: Add comment about image pull
          uri:
            url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
            method: POST
            headers:
              Authorization: "Bearer {{ wekan_token }}"
            body_format: json
            body:
              authorId: "{{ author_id }}"
              comment: "Image {{ image_name }}:{{ image_version }} pulled successfully\n\n```\n{{ pull_result.stdout | default('') }}{{ pull_result.stderr | default('') }}\n```"
            status_code: [200, 201]

        # ========================================
        # PART 8: Restart application
        # ========================================

        - name: Restart application with docker compose up -d
          ansible.builtin.command:
            cmd: docker compose up -d
          args:
            chdir: "{{ compose_path }}"
          register: restart_result

        - name: Add comment after restart
          uri:
            url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
            method: POST
            headers:
              Authorization: "Bearer {{ wekan_token }}"
            body_format: json
            body:
              authorId: "{{ author_id }}"
              comment: "Application restarted with docker compose up -d\n\n```\n{{ restart_result.stdout | default('') }}{{ restart_result.stderr | default('') }}\n```"
            status_code: [200, 201]

        # ========================================
        # PART 9: Healthcheck
        # ========================================

        - name: Wait for application to be ready (healthcheck)
          uri:
            url: "http://localhost:{{ app_port }}"
            method: GET
            status_code: 200
          register: health_check
          retries: 5
          delay: 3
          until: health_check.status == 200

        - name: Add healthcheck comment
          uri:
            url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
            method: POST
            headers:
              Authorization: "Bearer {{ wekan_token }}"
            body_format: json
            body:
              authorId: "{{ author_id }}"
              comment: "Healthcheck OK - Application responds on http://localhost:{{ app_port }} (status {{ health_check.status }})"
            status_code: [200, 201]

      rescue:
        # ========================================
        # ROLLBACK on failure
        # ========================================

        - name: "ROLLBACK - Failure comment"
          uri:
            url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
            method: POST
            headers:
              Authorization: "Bearer {{ wekan_token }}"
            body_format: json
            body:
              authorId: "{{ author_id }}"
              comment: "UPDATE FAILED! Rolling back..."
            status_code: [200, 201]

        - name: "ROLLBACK - Restore docker-compose.yml"
          copy:
            src: "{{ compose_path }}/docker-compose.yml.backup"
            dest: "{{ compose_path }}/docker-compose.yml"
            remote_src: yes

        - name: "ROLLBACK - Restart with previous configuration"
          ansible.builtin.command:
            cmd: docker compose up -d
          args:
            chdir: "{{ compose_path }}"

        - name: "ROLLBACK - Restoration comment"
          uri:
            url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
            method: POST
            headers:
              Authorization: "Bearer {{ wekan_token }}"
            body_format: json
            body:
              authorId: "{{ author_id }}"
              comment: "Rollback completed - Previous configuration restored"
            status_code: [200, 201]

        - name: "ROLLBACK - Error message"
          fail:
            msg: "Update failed! Rollback completed to previous version."

    # ========================================
    # PART 10: Status verification
    # ========================================

    - name: Display Docker container status
      ansible.builtin.command:
        cmd: docker ps --filter "name=web_app"
      register: docker_ps_output
      changed_when: false

    - name: Add docker ps result comment
      uri:
        url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
        method: POST
        headers:
          Authorization: "Bearer {{ wekan_token }}"
        body_format: json
        body:
          authorId: "{{ author_id }}"
          comment: "Container status after update\n\n```\n{{ docker_ps_output.stdout }}\n```"
        status_code: [200, 201]

    # ========================================
    # PART 11: Vulnerability scan
    # ========================================

    - name: Scan vulnerabilities with Trivy
      ansible.builtin.command:
        cmd: >
          docker run --rm
          -v /var/run/docker.sock:/var/run/docker.sock
          aquasec/trivy:latest
          image {{ image_name }}:{{ image_version }} --severity CRITICAL --no-progress
      register: trivy_scan_results
      changed_when: false
      ignore_errors: yes

    - name: Filter critical CVEs
      set_fact:
        critical_cves: "{{ trivy_scan_results.stdout | regex_findall('CVE-[0-9]{4}-[0-9]{4,7}') }}"
      when: trivy_scan_results is defined

    - name: Add Trivy scan result to ticket
      uri:
        url: "{{ wekan_url }}/api/boards/{{ board_id }}/cards/{{ card_id }}/comments"
        method: POST
        headers:
          Authorization: "Bearer {{ wekan_token }}"
        body_format: json
        body:
          authorId: "{{ author_id }}"
          comment: "Trivy vulnerability scan\n\nCritical CVEs count: {{ critical_cves | length }}\n\nCVEs found: {{ critical_cves | join(', ') }}"
        status_code: [200, 201]
      when: critical_cves is defined

    # ========================================
    # PART 12: Move ticket to Done
    # ========================================

    - name: Move ticket to Done
      uri:
        url: "{{ wekan_url }}/api/boards/{{ board_id }}/lists/{{ list_inprogress }}/cards/{{ card_id }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ wekan_token }}"
        body_format: json
        body:
          listId: "{{ list_done }}"
          swimlaneId: "{{ swimlane_id }}"
        status_code: [200, 204]

    # ========================================
    # PART 13: Final summary
    # ========================================

    - name: Display update summary
      debug:
        msg:
          - "========================================="
          - "Update completed successfully!"
          - "Updated image: {{ image_name }}:{{ image_version }}"
          - "WeKan ticket: {{ card_id }}"
          - "Healthcheck: OK"
          - "Critical CVEs: {{ critical_cves | length if critical_cves is defined else 'N/A' }}"
          - "Application restarted and available"
          - "========================================="
