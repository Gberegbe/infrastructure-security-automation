---
# Ansible Playbook for Docker Image Vulnerability Scanning with Trivy
# Usage: ansible-playbook scan_vulnerabilities.yml

- hosts: localhost
  gather_facts: no
  vars:
    compose_path: "{{ lookup('env', 'COMPOSE_PATH') | default('../application') }}"

  tasks:
    # Task 1: Get Docker image from docker-compose.yml
    - name: Get Docker image and version to scan
      ansible.builtin.set_fact:
        docker_image: "{{ lookup('file', compose_path + '/docker-compose.yml') | from_yaml | json_query('services.web.image') }}"

    # Task 2: Display the image being scanned
    - name: Display Docker image to scan
      debug:
        msg: "Docker image to scan: {{ docker_image }}"

    # Task 3: Run Trivy vulnerability scan
    - name: Run vulnerability scan with Trivy
      ansible.builtin.command:
        cmd: >
          docker run --rm
          -v /var/run/docker.sock:/var/run/docker.sock
          aquasec/trivy:latest
          image {{ docker_image }} --severity CRITICAL --no-progress
      register: trivy_scan_results
      changed_when: false

    # Task 4: Filter critical CVEs from results
    - name: Filter critical CVE identifiers
      set_fact:
        critical_cves: "{{ trivy_scan_results.stdout | regex_findall('CVE-[0-9]{4}-[0-9]{4,7}') }}"

    # Task 5: Display full scan results
    - name: Display full scan results
      debug:
        var: trivy_scan_results.stdout_lines

    # Task 6: Display critical CVEs found
    - name: Display critical CVEs found
      debug:
        msg: "Critical CVEs found: {{ critical_cves }}"

    # Task 7: Display total count of critical vulnerabilities
    - name: Display critical vulnerability count
      debug:
        msg: "Total critical CVEs: {{ critical_cves | length }}"
