# Docker Vulnerability Automation

Ansible playbooks for automating Docker image vulnerability management with Trivy scanning and WeKan ticketing integration.

## Features

- **Vulnerability Scanning**: Automated CVE detection using Trivy
- **Automatic Updates**: Update Docker images in docker-compose.yml files
- **Healthcheck Verification**: HTTP healthcheck after deployment
- **Automatic Rollback**: Restore previous version on failure (block/rescue pattern)
- **WeKan Integration**: Automatic ticket creation and status tracking
- **Ansible Vault**: Secure credential management

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Target VM                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │  Application │  │   Trivy      │  │       WeKan          │  │
│  │  (Docker)    │  │   Scanner    │  │   (Ticketing)        │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                 Ansible Playbooks                         │  │
│  │  • scan_vulnerabilities.yml  -> CVE detection            │  │
│  │  • update_docker_image.yml   -> Simple update            │  │
│  │  • update_docker_image_wekan.yml -> Update + tracking    │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## Quick Start

### 1. Scan vulnerabilities

```bash
cd ansible
ansible-playbook scan_vulnerabilities.yml
```

### 2. Update Docker image (simple)

```bash
ansible-playbook update_docker_image.yml -e "image_name=nginx image_version=1.24.0"
```

### 3. Update with WeKan tracking

```bash
# Setup vault first
cp vault.yml.example vault.yml
# Edit vault.yml with your credentials
ansible-vault encrypt vault.yml

# Run playbook
ansible-playbook update_docker_image_wekan.yml \
  -e "image_name=nginx image_version=1.24.0" \
  --ask-vault-pass
```

## Playbooks

| Playbook | Description |
|----------|-------------|
| `scan_vulnerabilities.yml` | Scan Docker image for critical CVEs using Trivy |
| `update_docker_image.yml` | Update image with healthcheck and automatic rollback |
| `update_docker_image_wekan.yml` | Full update with WeKan ticket tracking |
| `list_boards.yml` | Utility to retrieve WeKan board/list IDs |

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `COMPOSE_PATH` | Path to docker-compose.yml | `../application` |
| `APP_PORT` | Application HTTP port | `8087` |
| `WEKAN_URL` | WeKan server URL | - |
| `WEKAN_BOARD_ID` | Target board ID | - |

### Vault Configuration

Create `vault.yml` from example:

```yaml
vault_wekan_user: "your-username"
vault_wekan_pass: "your-password"
```

## Workflow

1. **Detection**: Trivy scans Docker image for vulnerabilities
2. **Qualification**: Review critical CVEs identified
3. **Remediation**: Execute update playbook
4. **Verification**: Automatic healthcheck + new Trivy scan
5. **Traceability**: WeKan ticket with complete history

## Safety Features

- **Pre-update backup**: docker-compose.yml saved before modification
- **HTTP healthcheck**: 5 retries with 3s delay
- **Automatic rollback**: Restore backup if healthcheck fails
- **WeKan audit trail**: Every step documented in ticket

## Requirements

- Ansible 2.9+
- Docker
- Trivy (runs as Docker container)
- WeKan (optional, for ticket tracking)

## License

MIT License - See [LICENSE](../LICENSE)
